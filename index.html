<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Personaliza tu Bingo</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;600;800&display=swap" rel="stylesheet">

<style>

body{
    font-family:'Poppins', sans-serif;
    background:linear-gradient(135deg,#667eea,#764ba2);
    color:white;
    text-align:center;
    margin:0;
}

h1{
    margin-top:20px;
    font-weight:800;
}

#loading{
    margin-top:40px;
    font-size:22px;
    opacity:.9;
}

#evento{
    opacity:.9;
    margin-bottom:10px;
}

.pointer{
    width:0;
    height:0;
    border-left:18px solid transparent;
    border-right:18px solid transparent;
    border-top:35px solid white;
    margin:10px auto -15px auto;
    z-index:10;
    position:relative;
}

#wheel-container{
    display:flex;
    justify-content:center;
    align-items:center;
}

#wheel{
    width:min(90vw,420px);
    height:min(90vw,420px);
    border-radius:50%;
    border:12px solid white;
    position:relative;
    overflow:hidden;
    box-shadow:
    inset 0 0 40px rgba(0,0,0,.4),
    0 20px 60px rgba(0,0,0,.4);
}

.slice{
    position:absolute;
    width:50%;
    height:50%;
    top:50%;
    left:50%;
    transform-origin:0% 0%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:clamp(10px,2vw,14px);
    font-weight:600;
    text-align:center;
}

button{
    margin-top:20px;
    padding:14px 35px;
    font-size:18px;
    border:none;
    border-radius:12px;
    background:#00f5a0;
    color:#003;
    font-weight:600;
    cursor:pointer;
    box-shadow:0 8px 25px rgba(0,0,0,.3);
    margin-right:10px;
}

button:hover{
    transform:scale(1.05);
}

#resultado{
    font-size:clamp(32px,8vw,72px);
    margin-top:25px;
    font-weight:800;
    line-height:1.1;
}

#contador{
    margin-top:10px;
    opacity:.85;
}

#historial{
    margin-top:20px;
    max-width:400px;
    margin-left:auto;
    margin-right:auto;
    opacity:.9;
}

canvas{
    position:fixed;
    pointer-events:none;
    top:0;
    left:0;
}

</style>
</head>

<body>

<h1>ðŸŽ‰ Personaliza tu Bingo ðŸŽ‰</h1>
<div id="loading">Cargando bingo...</div>
<div id="evento"></div>

<div class="pointer"></div>

<div id="wheel-container">
    <div id="wheel"></div>
</div>

<div id="controls">
<button id="spinBtn" onclick="spin()">GIRAR</button>
<button onclick="resetear()">REINICIAR</button>
<button onclick="fullscreen()">PANTALLA COMPLETA</button>
</div>

<div id="resultado" aria-live="polite"></div>
<div id="contador"></div>
<div id="historial"></div>

<canvas id="confetti"></canvas>

<audio id="tick" src="https://assets.mixkit.co/sfx/preview/mixkit-slot-machine-spin-1930.mp3"></audio>
<audio id="win" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3"></audio>

<script>

////////////////////////////////////////////////////
// PARAMETROS
////////////////////////////////////////////////////

const params = new URLSearchParams(window.location.search);
const id = params.get("id") || "demo";
const modoTV = params.get("modo");

const DATA_URL = `https://raw.githubusercontent.com/diegogallardo87/bingo-data/main/bingos/${id}.json?nocache=${Date.now()}`;
    
let palabras = [];
let originales = [];
let historial = [];

////////////////////////////////////////////////////
// FETCH
////////////////////////////////////////////////////

fetch(DATA_URL)
.then(r=>{
    if(!r.ok) throw new Error("No se encontrÃ³ el bingo");
    return r.json();
})
.then(data=>{

    const guardado = localStorage.getItem(id);

    if(guardado){
        const estado = JSON.parse(guardado);
        palabras = estado.palabras;
        historial = estado.historial;
    }else{
        palabras = [...data.lista];
        historial = [];
    }

    originales = [...data.lista];

    document.getElementById("evento").innerText = data.evento || "";
    document.getElementById("loading").style.display="none";

    if(modoTV === "tv"){
        document.getElementById("controls").style.display="none";
    }

    crearRuleta();
})
.catch(()=>{
    document.body.innerHTML = `
        <h1>Bingo no encontrado</h1>
        <p>Verifica el enlace.</p>
    `;
});

////////////////////////////////////////////////////

const wheel = document.getElementById("wheel");
const spinBtn = document.getElementById("spinBtn");

function guardarEstado(){
    localStorage.setItem(id, JSON.stringify({palabras, historial}));
}

// Genera un color distinto para cada palabra
function color(i){
    const hue = Math.floor((360 / Math.max(palabras.length,1)) * i);
    return `hsl(${hue}, 75%, 60%)`;
}

function randomColor(){
    return `hsl(${Math.random()*360}, 75%, 60%)`;
}

function crearRuleta(){

wheel.innerHTML="";

if(palabras.length === 0){
    actualizarUI();
    return;
}

let angle = 360/palabras.length;

palabras.forEach((p,i)=>{

let slice=document.createElement("div");
slice.className="slice";
slice.style.background=colo
