<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Personaliza tu Bingo</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;600;800&display=swap" rel="stylesheet">

<style>

body{
    font-family:'Poppins', sans-serif;
    background:linear-gradient(135deg,#667eea,#764ba2);
    color:white;
    text-align:center;
    margin:0;
}

h1{
    margin-top:20px;
    font-weight:800;
    font-size:clamp(28px,6vw,56px);
}

#evento{
    font-size:clamp(18px,4vw,36px);
    font-weight:600;
    margin-bottom:15px;
    color:#ffe082;
}

.pointer{
    width:0;
    height:0;
    border-left:18px solid transparent;
    border-right:18px solid transparent;
    border-top:35px solid white;
    margin:10px auto -15px auto;
}

#wheel{
    width:min(90vw,500px);
    aspect-ratio:1/1;
    max-width:500px;
    border-radius:50%;
    border:12px solid white;
    box-shadow:
    inset 0 0 40px rgba(0,0,0,.4),
    0 20px 60px rgba(0,0,0,.4);
}

button{
    margin-top:20px;
    padding:14px 35px;
    font-size:18px;
    border:none;
    border-radius:12px;
    background:#00f5a0;
    color:#003;
    font-weight:600;
    cursor:pointer;
    margin-right:10px;
}

#resultado{
    font-size:clamp(32px,10vw,64px);
    margin-top:25px;
    font-weight:800;
}

</style>
</head>

<body>

<h1>ðŸŽ‰ Personaliza tu Bingo ðŸŽ‰</h1>
<div id="evento"></div>

<div class="pointer"></div>
<canvas id="wheel"></canvas>

<div>
<button onclick="spin()">GIRAR</button>
<button onclick="resetear()">REINICIAR</button>
</div>

<div id="resultado"></div>
<div id="contador"></div>
<div id="historial"></div>

<script>

const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");

let palabras = [];
let originales = [];
let historial = [];

// Obtener ID desde la URL
const params = new URLSearchParams(window.location.search);
const id = params.get("id") || "demo";

// URL del JSON en GitHub (versiÃ³n estable con jsDelivr)
const DATA_URL =
`https://cdn.jsdelivr.net/gh/diegogallardo87/bingo-data@main/bingos/${id}.json`;

// Cargar datos
fetch(DATA_URL)
.then(r => {
    if(!r.ok) throw new Error("No se pudo cargar el JSON");
    return r.json();
})
.then(data => {

    palabras = [...data.lista];
    originales = [...data.lista];

    document.getElementById("evento").innerText = data.evento || "";

    resizeCanvas(); // dibuja cuando ya tenga datos
    actualizarUI();
})
.catch(err=>{
    console.error("Error cargando JSON:", err);

    // Fallback por si falla GitHub
    palabras = ["DEMO","RULETA","BINGO","PERSONALIZADO"];
    originales = [...palabras];

    resizeCanvas();
});

let rotation = 0;
let girando = false;
let radius;

////////////////////////////////////////////////////
// CANVAS PERFECTAMENTE NÃTIDO
////////////////////////////////////////////////////

function resizeCanvas(){

    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;

    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;

    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    radius = rect.width / 2;

    drawWheel(rotation);
}

window.addEventListener("resize", resizeCanvas);
resizeCanvas();

////////////////////////////////////////////////////

function color(i){
    const hue = Math.floor((360 / palabras.length) * i);
    return `hsl(${hue},75%,60%)`;
}

////////////////////////////////////////////////////

function drawWheel(rotDeg=0){

    if(palabras.length===0) return;

    ctx.clearRect(0,0,canvas.width,canvas.height);

    ctx.save();

    ctx.translate(radius,radius);
    ctx.rotate((rotDeg%360)*Math.PI/180);
    ctx.translate(-radius,-radius);

    const angle = (2*Math.PI)/palabras.length;

    palabras.forEach((p,i)=>{

        let start = i*angle;
        let end = start + angle;

        ctx.beginPath();
        ctx.moveTo(radius,radius);
        ctx.arc(radius,radius,radius,start,end);
        ctx.fillStyle = color(i);
        ctx.fill();

        ctx.save();

        ctx.translate(radius,radius);
        ctx.rotate(start + angle/2);

        ctx.textAlign="right";

        // TEXTO NEGRO
        ctx.fillStyle="#000";
        ctx.strokeStyle="#fff";
        ctx.lineWidth=3;

        let fontSize = Math.max(14, radius/10);
        ctx.font=`bold ${fontSize}px Poppins`;

        ctx.strokeText(p, radius-20, 8);
        ctx.fillText(p, radius-20, 8);

        ctx.restore();

    });

    ctx.restore();
}

////////////////////////////////////////////////////

function spin(){

    if(girando) return;
    if(palabras.length===0) return;

    girando=true;

    const spins = 8 + Math.random()*4;
    const extra = Math.random()*360;
    const finalRotation = rotation + spins*360 + extra;

    let start=null;
    const duration=5000;

    function animate(ts){

        if(!start) start=ts;

        let progress = (ts-start)/duration;
        progress=Math.min(progress,1);

        let ease = 1-Math.pow(1-progress,4);
        let current = rotation + (finalRotation-rotation)*ease;

        drawWheel(current);

        if(progress<1){
            requestAnimationFrame(animate);
        }else{

            rotation = finalRotation % 360;

            const slice = 360 / palabras.length;
            const pointerDeg = 270;

            let adjusted = (pointerDeg - rotation + 360) % 360;
            const index = Math.floor(adjusted / slice);

            let ganador = palabras.splice(index,1)[0];

// Guardar en historial
historial.unshift("ðŸŽ‰ " + ganador);

// Mostrar ganador grande
document.getElementById("resultado").innerText =
ganador.toUpperCase();

// Redibujar sin esa palabra
drawWheel(rotation);

// Actualizar contador e historial en pantalla
actualizarUI();

girando=false;

        }
    }

    requestAnimationFrame(animate);
}

    function actualizarUI(){

    document.getElementById("contador").innerText =
    "Quedan " + palabras.length + " palabras";

    document.getElementById("historial").innerHTML =
    historial.length
    ? "<b>Ya salieron:</b><br>" + historial.join("<br>")
    : "";
}
////////////////////////////////////////////////////

function resetear(){
    palabras=[...originales];
    historial=[];
    rotation=0;

    document.getElementById("resultado").innerText="";
    actualizarUI();
    drawWheel(rotation);
}

</script>

</body>
</html>
